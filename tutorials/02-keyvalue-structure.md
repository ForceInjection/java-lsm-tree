ğŸ”¥ æ¨èä¸€ä¸ªé«˜è´¨é‡çš„Java LSM Treeå¼€æºé¡¹ç›®ï¼
[https://github.com/brianxiadong/java-lsm-tree](https://github.com/brianxiadong/java-lsm-tree)
**java-lsm-tree** æ˜¯ä¸€ä¸ªä»é›¶å®ç°çš„Log-Structured Merge Treeï¼Œä¸“ä¸ºé«˜å¹¶å‘å†™å…¥åœºæ™¯è®¾è®¡ã€‚
æ ¸å¿ƒäº®ç‚¹ï¼š
âš¡ æè‡´æ€§èƒ½ï¼šå†™å…¥é€Ÿåº¦è¶…è¿‡40ä¸‡ops/ç§’ï¼Œå®Œçˆ†ä¼ ç»ŸB+æ ‘
ğŸ—ï¸ å®Œæ•´æ¶æ„ï¼šMemTableè·³è¡¨ + SSTable + WAL + å¸ƒéš†è¿‡æ»¤å™¨ + å¤šçº§å‹ç¼©
ğŸ“š æ·±åº¦æ•™ç¨‹ï¼š12ç« è¯¦ç»†æ•™ç¨‹ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§ä¼˜åŒ–ï¼Œæ¯è¡Œä»£ç éƒ½æœ‰æ³¨é‡Š
ğŸ”’ å¹¶å‘å®‰å…¨ï¼šè¯»å†™é”æœºåˆ¶ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯
ğŸ’¾ æ•°æ®å¯é ï¼šWALå†™å‰æ—¥å¿—ç¡®ä¿å´©æºƒæ¢å¤ï¼Œé›¶æ•°æ®ä¸¢å¤±
é€‚åˆè°ï¼Ÿ
- æƒ³æ·±å…¥ç†è§£LSM TreeåŸç†çš„å¼€å‘è€…
- éœ€è¦é«˜å†™å…¥æ€§èƒ½å­˜å‚¨å¼•æ“çš„é¡¹ç›®
- å‡†å¤‡æ•°æ®åº“/å­˜å‚¨ç³»ç»Ÿé¢è¯•çš„åŒå­¦
- å¯¹åˆ†å¸ƒå¼å­˜å‚¨æ„Ÿå…´è¶£çš„å·¥ç¨‹å¸ˆ
â­ ç»™ä¸ªStaræ”¯æŒå¼€æºï¼

# ç¬¬2ç« ï¼šKeyValue æ•°æ®ç»“æ„

## ä¸ºä»€ä¹ˆéœ€è¦KeyValueç»“æ„ï¼Ÿ

åœ¨LSM Treeä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½ç®€å•åœ°å­˜å‚¨åŸå§‹çš„é”®å€¼å¯¹ï¼Œå› ä¸ºéœ€è¦å¤„ç†ä»¥ä¸‹é—®é¢˜ï¼š
- **æ—¶é—´ç‰ˆæœ¬æ§åˆ¶**: åŒä¸€ä¸ªé”®å¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬
- **åˆ é™¤è¯­ä¹‰**: å¦‚ä½•è¡¨ç¤ºåˆ é™¤æ“ä½œ
- **æ•°æ®å®Œæ•´æ€§**: ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§

å› æ­¤ï¼Œæˆ‘ä»¬è®¾è®¡äº†`KeyValue`ç±»ä½œä¸ºLSM Treeçš„åŸºç¡€æ•°æ®å•å…ƒã€‚
> æœ¬è´¨åŸå› æ˜¯æˆ‘ä»¬å°½é‡è¦ä½¿ç”¨é¡ºåºå†™ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯è¾ƒé«˜çš„å†™å…¥é€Ÿåº¦ã€‚ä½†æ˜¯é¡ºåºå†™çš„åŒæ—¶ï¼Œå¦‚æœæœ‰è€çš„ç›¸åŒKeyçš„æ•°æ®ï¼Œä¸å¯èƒ½å†å›è¿‡å¤´å»åˆ é™¤å®ƒï¼Œè¿™æ ·ä¹Ÿä¼šå½±å“æ•ˆç‡ï¼Œæ‰€ä»¥æ‰äº§ç”Ÿäº†ä¸Šè¿°çš„ä¸‰ä¸ªé—®é¢˜ã€‚

## KeyValue ç±»è®¾è®¡

è®©æˆ‘ä»¬çœ‹çœ‹å®é™…çš„å®ç°ï¼š

```java
package com.brianxiadong.lsmtree;

/**
 * LSM Treeä¸­çš„é”®å€¼å¯¹æ•°æ®ç»“æ„
 * åŒ…å«é”®ã€å€¼å’Œæ—¶é—´æˆ³ä¿¡æ¯
 */
public class KeyValue implements Comparable<KeyValue> {
    // é”®å­—æ®µï¼šå­˜å‚¨æ•°æ®çš„å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œä¸å¯å˜
    private final String key;        
    // å€¼å­—æ®µï¼šå­˜å‚¨å®é™…æ•°æ®å†…å®¹ï¼Œåˆ é™¤æ—¶ä¸ºnull
    private final String value;      
    // æ—¶é—´æˆ³ï¼šè®°å½•æ•°æ®å†™å…¥çš„æ—¶é—´ï¼Œç”¨äºç‰ˆæœ¬æ§åˆ¶
    private final long timestamp;    
    // åˆ é™¤æ ‡è®°ï¼šæ ‡è¯†è¯¥è®°å½•æ˜¯å¦ä¸ºåˆ é™¤æ“ä½œï¼ˆå¢“ç¢‘ï¼‰
    private final boolean deleted;   

    // æ„é€ å‡½æ•°ï¼šåˆ›å»ºæ­£å¸¸çš„é”®å€¼å¯¹
    public KeyValue(String key, String value) {
        this(key, value, System.currentTimeMillis(), false);  // è°ƒç”¨å®Œæ•´æ„é€ å‡½æ•°
    }
    
    // å®Œæ•´æ„é€ å‡½æ•°ï¼šç”¨äºåˆ›å»ºç‰¹å®šçŠ¶æ€çš„KeyValueå¯¹è±¡
    public KeyValue(String key, String value, long timestamp, boolean deleted) {
        this.key = key;              // è®¾ç½®é”®
        this.value = value;          // è®¾ç½®å€¼ï¼ˆå¯èƒ½ä¸ºnullï¼‰
        this.timestamp = timestamp;  // è®¾ç½®æŒ‡å®šçš„æ—¶é—´æˆ³
        this.deleted = deleted;      // è®¾ç½®åˆ é™¤æ ‡è®°
    }
    
    /**
     * åˆ›å»ºåˆ é™¤æ ‡è®°çš„é”®å€¼å¯¹
     */
    public static KeyValue createTombstone(String key) {
        // åˆ›å»ºä¸€ä¸ªåˆ é™¤æ ‡è®°ï¼Œå€¼ä¸ºnullï¼Œæ ‡è®°ä¸ºå·²åˆ é™¤
        return new KeyValue(key, null, System.currentTimeMillis(), true);
    }
    
    // è·å–é”®çš„æ–¹æ³•
    public String getKey() {
        return key;
    }
    
    // è·å–å€¼çš„æ–¹æ³•
    public String getValue() {
        return value;
    }
    
    // è·å–æ—¶é—´æˆ³çš„æ–¹æ³•
    public long getTimestamp() {
        return timestamp;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä¸ºåˆ é™¤æ ‡è®°çš„æ–¹æ³•
    public boolean isDeleted() {
        return deleted;
    }
    
    // å®ç°Comparableæ¥å£ï¼Œç”¨äºæ’åº
    @Override
    public int compareTo(KeyValue other) {
        int keyCompare = this.key.compareTo(other.key);    // é¦–å…ˆæŒ‰é”®æ’åº
        if (keyCompare != 0) {
            return keyCompare;                             // é”®ä¸åŒï¼Œè¿”å›é”®çš„æ¯”è¾ƒç»“æœ
        }
        // å¦‚æœé”®ç›¸åŒï¼ŒæŒ‰æ—¶é—´æˆ³é™åºæ’åˆ—ï¼ˆæ–°çš„åœ¨å‰ï¼‰
        return Long.compare(other.timestamp, this.timestamp);
    }
    
    // é‡å†™toStringæ–¹æ³•ï¼Œä¾¿äºè°ƒè¯•
    @Override
    public String toString() {
        return String.format("KeyValue{key='%s', value='%s', timestamp=%d, deleted=%s}",
                key, value, timestamp, deleted);
    }
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªKeyValueç±»æ˜¯LSM Treeçš„æ ¸å¿ƒæ•°æ®ç»“æ„ã€‚å®ƒä½¿ç”¨`final`å…³é”®å­—ç¡®ä¿å¯¹è±¡çš„ä¸å¯å˜æ€§ï¼Œè¿™åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹éå¸¸é‡è¦ã€‚æ—¶é—´æˆ³å­—æ®µè®©æˆ‘ä»¬èƒ½å¤Ÿå¤„ç†åŒä¸€é”®çš„å¤šä¸ªç‰ˆæœ¬ï¼Œè€Œåˆ é™¤æ ‡è®°åˆ™å®ç°äº†LSM Treeç‰¹æœ‰çš„"é€»è¾‘åˆ é™¤"æœºåˆ¶ã€‚

## æ ¸å¿ƒæ¦‚å¿µè¯¦è§£

### 1. æ—¶é—´æˆ³ (Timestamp)

**ä½œç”¨**: è®°å½•æ•°æ®å†™å…¥çš„æ—¶é—´ï¼Œç”¨äºç‰ˆæœ¬æ§åˆ¶å’Œå†²çªè§£å†³ã€‚

```java
// æ—¶é—´æˆ³çš„ä½¿ç”¨åœºæ™¯
KeyValue kv1 = new KeyValue("user:1", "Alice");  // åˆ›å»ºç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œtimestamp: 1640995200000
Thread.sleep(1);                                  // ç­‰å¾…1æ¯«ç§’ç¡®ä¿æ—¶é—´æˆ³ä¸åŒ
KeyValue kv2 = new KeyValue("user:1", "Bob");     // åˆ›å»ºç¬¬äºŒä¸ªç‰ˆæœ¬ï¼Œtimestamp: 1640995200001

// æŸ¥è¯¢æ—¶ï¼Œè¾ƒæ–°çš„æ—¶é—´æˆ³ä¼˜å…ˆ
assert kv2.getTimestamp() > kv1.getTimestamp();   // éªŒè¯æ—¶é—´æˆ³é¡ºåº
```

**ä»£ç è§£é‡Š**: è¿™æ®µä»£ç å±•ç¤ºäº†æ—¶é—´æˆ³çš„é‡è¦ä½œç”¨ã€‚å½“åŒä¸€ä¸ªé”®æœ‰å¤šä¸ªç‰ˆæœ¬æ—¶ï¼Œæ—¶é—´æˆ³å¸®åŠ©æˆ‘ä»¬ç¡®å®šå“ªä¸ªç‰ˆæœ¬æ˜¯æœ€æ–°çš„ã€‚é€šè¿‡`Thread.sleep(1)`ç¡®ä¿ä¸¤ä¸ªæ“ä½œæœ‰ä¸åŒçš„æ—¶é—´æˆ³ï¼Œè¿™åœ¨å®é™…åº”ç”¨ä¸­ä½“ç°äº†LSM Treeçš„ç‰ˆæœ¬æ§åˆ¶æœºåˆ¶ã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨æ—¶é—´æˆ³ï¼Ÿ**
- **ç‰ˆæœ¬æ§åˆ¶**: åŒä¸€é”®çš„å¤šä¸ªç‰ˆæœ¬æŒ‰æ—¶é—´æ’åº
- **å†²çªè§£å†³**: å‹ç¼©æ—¶ä¿ç•™æœ€æ–°ç‰ˆæœ¬
- **è°ƒè¯•è¿½è¸ª**: ä¾¿äºé—®é¢˜æ’æŸ¥å’Œæ•°æ®å®¡è®¡

### 2. åˆ é™¤æ ‡è®° (Tombstone)

åœ¨LSM Treeä¸­ï¼Œåˆ é™¤æ“ä½œä¸æ˜¯ç«‹å³ç‰©ç†åˆ é™¤ï¼Œè€Œæ˜¯æ’å…¥ä¸€ä¸ª"å¢“ç¢‘"æ ‡è®°ã€‚åœ¨æŸ¥è¯¢æ—¶ï¼ŒæŸ¥è¯¢åˆ°æ—¶é—´æˆ³æœ€å¤§çš„æ•°æ®ï¼Œå‘ç°æ˜¯ä¸€ä¸ªå¢“ç¢‘æ•°æ®ï¼Œé‚£ä¹ˆä»£è¡¨è¿™ä¸ªæ•°æ®è¢«åˆ é™¤äº†ã€‚

```java
// æ­£å¸¸çš„é”®å€¼å¯¹
KeyValue normalKV = new KeyValue("user:1", "Alice");  // åˆ›å»ºæ­£å¸¸é”®å€¼å¯¹
assert !normalKV.isDeleted();                         // éªŒè¯ä¸æ˜¯åˆ é™¤æ ‡è®°
assert normalKV.getValue().equals("Alice");           // éªŒè¯å€¼æ­£ç¡®

// åˆ é™¤æ ‡è®°ï¼ˆå¢“ç¢‘ï¼‰
KeyValue tombstone = KeyValue.createTombstone("user:1");  // åˆ›å»ºåˆ é™¤æ ‡è®°
assert tombstone.isDeleted();                             // éªŒè¯æ˜¯åˆ é™¤æ ‡è®°
assert tombstone.getValue() == null;                      // éªŒè¯å€¼ä¸ºnull
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªä¾‹å­æ¸…æ¥šåœ°å±•ç¤ºäº†æ­£å¸¸é”®å€¼å¯¹å’Œåˆ é™¤æ ‡è®°çš„åŒºåˆ«ã€‚åˆ é™¤æ ‡è®°æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„KeyValueå¯¹è±¡ï¼Œå®ƒçš„å€¼ä¸ºnullï¼Œåˆ é™¤æ ‡è®°ä¸ºtrueã€‚è¿™ç§è®¾è®¡å…è®¸LSM Treeåœ¨ä¸ä¿®æ”¹å·²å­˜åœ¨æ–‡ä»¶çš„æƒ…å†µä¸‹å¤„ç†åˆ é™¤æ“ä½œã€‚

**ä¸ºä»€ä¹ˆä½¿ç”¨åˆ é™¤æ ‡è®°ï¼Ÿ**

1. **LSMç‰¹æ€§**: ä¸èƒ½å°±åœ°ä¿®æ”¹å·²å†™å…¥çš„SSTableæ–‡ä»¶
2. **æ€§èƒ½è€ƒè™‘**: é¿å…ç«‹å³çš„ç£ç›˜éšæœºI/O
3. **ä¸€è‡´æ€§**: ç¡®ä¿åˆ é™¤æ“ä½œçš„æŒä¹…æ€§å’Œå¯è§æ€§

**åˆ é™¤æ ‡è®°çš„ç”Ÿå‘½å‘¨æœŸ**:
```
1. ç”¨æˆ·è°ƒç”¨delete("key")
     â†“
2. æ’å…¥tombstoneåˆ°MemTable
     â†“ 
3. åˆ·ç›˜åˆ°SSTableï¼ˆåŒ…å«tombstoneï¼‰
     â†“
4. å‹ç¼©æ—¶æ¸…ç†è¿‡æœŸtombstone
     â†“
5. ç‰©ç†åˆ é™¤å®Œæˆ
```

### 3. ä¸å¯å˜æ€§ (Immutability)

KeyValueå¯¹è±¡æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€æœ‰å­—æ®µéƒ½æ˜¯`final`ã€‚

**ä¸å¯å˜æ€§çš„å¥½å¤„**:
- **çº¿ç¨‹å®‰å…¨**: å¤šçº¿ç¨‹ç¯å¢ƒä¸‹å®‰å…¨å…±äº«
- **ç¼“å­˜å‹å¥½**: å¯ä»¥å®‰å…¨ç¼“å­˜å¼•ç”¨
- **è¯­ä¹‰æ¸…æ™°**: é¿å…æ„å¤–ä¿®æ”¹

```java
// åˆ›å»ºåä¸èƒ½ä¿®æ”¹
KeyValue kv = new KeyValue("key", "value");  // åˆ›å»ºä¸å¯å˜å¯¹è±¡
// kv.key = "newKey";  // ç¼–è¯‘é”™è¯¯ï¼šfinalå­—æ®µä¸èƒ½ä¿®æ”¹
```

**ä»£ç è§£é‡Š**: ç”±äºæ‰€æœ‰å­—æ®µéƒ½å£°æ˜ä¸º`final`ï¼ŒKeyValueå¯¹è±¡ä¸€æ—¦åˆ›å»ºå°±æ— æ³•ä¿®æ”¹ã€‚è¿™ç§è®¾è®¡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ç‰¹åˆ«æœ‰ç”¨ï¼Œå› ä¸ºå¤šä¸ªçº¿ç¨‹å¯ä»¥å®‰å…¨åœ°è¯»å–åŒä¸€ä¸ªKeyValueå¯¹è±¡ï¼Œè€Œä¸ç”¨æ‹…å¿ƒæ•°æ®ç«äº‰é—®é¢˜ã€‚

## å®é™…åº”ç”¨ç¤ºä¾‹

### 1. åŸºæœ¬CRUDæ“ä½œ

```java
public class KeyValueExample {
    public static void main(String[] args) {
        // åˆ›å»ºæ•°æ®ï¼šæ„é€ ä¸€ä¸ªæ–°çš„é”®å€¼å¯¹
        KeyValue create = new KeyValue("user:1001", "Alice");
        System.out.printf("åˆ›å»º: %s = %s (æ—¶é—´: %d)%n", 
                         create.getKey(),          // è·å–é”®
                         create.getValue(),        // è·å–å€¼
                         create.getTimestamp());   // è·å–æ—¶é—´æˆ³
        
        // æ›´æ–°æ•°æ®ï¼šåˆ›å»ºåŒä¸€é”®çš„æ–°ç‰ˆæœ¬ï¼ˆLSM Treeä¸æ”¯æŒå°±åœ°æ›´æ–°ï¼‰
        KeyValue update = new KeyValue("user:1001", "Alice Smith");
        System.out.printf("æ›´æ–°: %s = %s (æ—¶é—´: %d)%n", 
                         update.getKey(),          // é”®ä¿æŒä¸å˜
                         update.getValue(),        // æ–°çš„å€¼
                         update.getTimestamp());   // æ–°çš„æ—¶é—´æˆ³
        
        // åˆ é™¤æ•°æ®ï¼šåˆ›å»ºå¢“ç¢‘æ ‡è®°è€Œä¸æ˜¯ç‰©ç†åˆ é™¤
        KeyValue delete = KeyValue.createTombstone("user:1001");
        System.out.printf("åˆ é™¤: %s (åˆ é™¤æ ‡è®°: %b, æ—¶é—´: %d)%n", 
                         delete.getKey(),          // é”®ä¿æŒä¸å˜
                         delete.isDeleted(),       // åˆ é™¤æ ‡è®°ä¸ºtrue
                         delete.getTimestamp());   // åˆ é™¤æ“ä½œçš„æ—¶é—´æˆ³
    }
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªç¤ºä¾‹å±•ç¤ºäº†LSM Treeä¸­çš„åŸºæœ¬æ“ä½œæ¨¡å¼ã€‚æ³¨æ„"æ›´æ–°"æ“ä½œå®é™…ä¸Šæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„KeyValueå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰å¯¹è±¡ã€‚åˆ é™¤æ“ä½œåˆ›å»ºä¸€ä¸ªç‰¹æ®Šçš„å¢“ç¢‘è®°å½•ã€‚æ¯ä¸ªæ“ä½œéƒ½æœ‰ç‹¬ç‰¹çš„æ—¶é—´æˆ³ï¼Œè¿™ä½¿å¾—ç³»ç»Ÿèƒ½å¤Ÿè¿½è¸ªæ•°æ®çš„å®Œæ•´å†å²ã€‚

**è¾“å‡º**:
```
åˆ›å»º: user:1001 = Alice (æ—¶é—´: 1640995200000)
æ›´æ–°: user:1001 = Alice Smith (æ—¶é—´: 1640995200001)  
åˆ é™¤: user:1001 (åˆ é™¤æ ‡è®°: true, æ—¶é—´: 1640995200002)
```

### 2. ç‰ˆæœ¬æ§åˆ¶ç¤ºä¾‹

```java
public class VersionControlExample {
    public static void main(String[] args) throws InterruptedException {
        List<KeyValue> versions = new ArrayList<>();  // å­˜å‚¨åŒä¸€é”®çš„å¤šä¸ªç‰ˆæœ¬
        
        // æ¨¡æ‹ŸåŒä¸€é”®çš„å¤šä¸ªç‰ˆæœ¬
        versions.add(new KeyValue("config", "v1.0"));      // æ·»åŠ ç¬¬ä¸€ä¸ªç‰ˆæœ¬
        Thread.sleep(10);                                   // ç¡®ä¿æ—¶é—´æˆ³ä¸åŒ
        versions.add(new KeyValue("config", "v1.1"));      // æ·»åŠ ç¬¬äºŒä¸ªç‰ˆæœ¬
        Thread.sleep(10);                                   // å†æ¬¡ç¡®ä¿æ—¶é—´æˆ³ä¸åŒ
        versions.add(KeyValue.createTombstone("config"));  // æ·»åŠ åˆ é™¤æ ‡è®°
        
        // æŒ‰æ—¶é—´æˆ³æ’åºï¼Œæ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬ï¼ˆæ—¶é—´æˆ³è¶Šå¤§è¶Šæ–°ï¼‰
        versions.sort((a, b) -> Long.compare(b.getTimestamp(), a.getTimestamp()));
        
        KeyValue latest = versions.get(0);  // è·å–æ—¶é—´æˆ³æœ€å¤§ï¼ˆæœ€æ–°ï¼‰çš„ç‰ˆæœ¬
        if (latest.isDeleted()) {           // æ£€æŸ¥æœ€æ–°ç‰ˆæœ¬æ˜¯å¦ä¸ºåˆ é™¤æ ‡è®°
            System.out.println("é”® 'config' å·²è¢«åˆ é™¤");
        } else {
            System.out.println("æœ€æ–°å€¼: " + latest.getValue());  // è¾“å‡ºæœ€æ–°çš„å€¼
        }
    }
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªä¾‹å­æ¨¡æ‹Ÿäº†LSM Treeä¸­åŒä¸€é”®çš„å¤šä¸ªç‰ˆæœ¬å…±å­˜çš„æƒ…å†µã€‚é€šè¿‡å¯¹æ—¶é—´æˆ³è¿›è¡Œæ’åºï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æœ€æ–°çš„ç‰ˆæœ¬ã€‚è¿™ç§æœºåˆ¶è®©LSM Treeèƒ½å¤Ÿå¤„ç†é«˜å¹¶å‘å†™å…¥ï¼ŒåŒæ—¶ä¿æŒæ•°æ®çš„ä¸€è‡´æ€§ã€‚æ³¨æ„æˆ‘ä»¬ä½¿ç”¨`Thread.sleep(10)`æ¥ç¡®ä¿æ¯ä¸ªç‰ˆæœ¬æœ‰ä¸åŒçš„æ—¶é—´æˆ³ã€‚

### 3. å‹ç¼©åœºæ™¯æ¨¡æ‹Ÿ

```java
public class CompactionExample {
    // å‹ç¼©å¤šä¸ªKeyValueè®°å½•ï¼Œåªä¿ç•™æ¯ä¸ªé”®çš„æœ€æ–°ç‰ˆæœ¬
    public static List<KeyValue> compactKeyValues(List<KeyValue> input) {
        // æŒ‰é”®åˆ†ç»„ï¼šå°†ç›¸åŒé”®çš„æ‰€æœ‰ç‰ˆæœ¬æ”¾åœ¨ä¸€èµ·
        Map<String, List<KeyValue>> grouped = input.stream()
            .collect(Collectors.groupingBy(KeyValue::getKey));
        
        List<KeyValue> result = new ArrayList<>();  // å­˜å‚¨å‹ç¼©åçš„ç»“æœ
        
        // å¯¹æ¯ä¸ªé”®ï¼Œåªä¿ç•™æœ€æ–°çš„ç‰ˆæœ¬
        for (Map.Entry<String, List<KeyValue>> entry : grouped.entrySet()) {
            List<KeyValue> versions = entry.getValue();  // è·å–è¯¥é”®çš„æ‰€æœ‰ç‰ˆæœ¬
            
            // æŒ‰æ—¶é—´æˆ³å€’åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            versions.sort((a, b) -> Long.compare(b.getTimestamp(), a.getTimestamp()));
            
            KeyValue latest = versions.get(0);  // è·å–æœ€æ–°ç‰ˆæœ¬
            
            // å¦‚æœæœ€æ–°ç‰ˆæœ¬ä¸æ˜¯åˆ é™¤æ ‡è®°ï¼Œåˆ™ä¿ç•™å®ƒ
            if (!latest.isDeleted()) {
                result.add(latest);  // æ·»åŠ åˆ°ç»“æœä¸­
            }
            // åˆ é™¤æ ‡è®°ï¼šåœ¨å‹ç¼©æ—¶å¯ä»¥å½»åº•æ¸…é™¤ï¼Œä¸æ·»åŠ åˆ°ç»“æœä¸­
        }
        
        return result;  // è¿”å›å‹ç¼©åçš„ç»“æœ
    }
    
    public static void main(String[] args) {
        // åˆ›å»ºæµ‹è¯•æ•°æ®ï¼šåŒ…å«å¤šä¸ªç‰ˆæœ¬å’Œåˆ é™¤æ ‡è®°
        List<KeyValue> input = Arrays.asList(
            new KeyValue("user:1", "v1"),              // user:1çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬
            new KeyValue("user:1", "v2"),              // user:1çš„ç¬¬äºŒä¸ªç‰ˆæœ¬ï¼ˆæ›´æ–°ï¼‰
            new KeyValue("user:2", "Alice"),           // user:2çš„å€¼
            KeyValue.createTombstone("user:2"),        // user:2çš„åˆ é™¤æ ‡è®°
            new KeyValue("user:3", "Bob")              // user:3çš„å€¼
        );
        
        // æ‰§è¡Œå‹ç¼©æ“ä½œ
        List<KeyValue> compacted = compactKeyValues(input);
        
        // è¾“å‡ºå‹ç¼©å‰åçš„è®°å½•æ•°é‡
        System.out.println("å‹ç¼©å‰: " + input.size() + " æ¡è®°å½•");
        System.out.println("å‹ç¼©å: " + compacted.size() + " æ¡è®°å½•");
        
        // è¾“å‡ºå‹ç¼©åä¿ç•™çš„è®°å½•
        compacted.forEach(kv -> 
            System.out.println(kv.getKey() + " = " + kv.getValue())
        );
    }
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªå‹ç¼©ç¤ºä¾‹å±•ç¤ºäº†LSM Treeä¸­çš„å…³é”®æ“ä½œã€‚å‹ç¼©è¿‡ç¨‹ä¼šéå†æ‰€æœ‰çš„KeyValueè®°å½•ï¼Œå¯¹äºæ¯ä¸ªé”®åªä¿ç•™æœ€æ–°çš„ç‰ˆæœ¬ã€‚å¦‚æœæœ€æ–°ç‰ˆæœ¬æ˜¯åˆ é™¤æ ‡è®°ï¼Œé‚£ä¹ˆè¯¥é”®çš„æ‰€æœ‰å†å²ç‰ˆæœ¬éƒ½ä¼šè¢«æ¸…é™¤ã€‚è¿™ä¸ªè¿‡ç¨‹æœ‰æ•ˆåœ°å‡å°‘äº†å­˜å‚¨ç©ºé—´å¹¶æé«˜äº†æŸ¥è¯¢æ€§èƒ½ã€‚

**è¾“å‡º**:
```
å‹ç¼©å‰: 5 æ¡è®°å½•
å‹ç¼©å: 2 æ¡è®°å½•
user:1 = v2
user:3 = Bob
```

## è®¾è®¡è€ƒè™‘

### 1. å†…å­˜æ•ˆç‡

KeyValueå¯¹è±¡éœ€è¦é¢‘ç¹åˆ›å»ºï¼Œæˆ‘ä»¬ä¼˜åŒ–äº†å†…å­˜ä½¿ç”¨ï¼š

```java
// å­—ç¬¦ä¸²æ± åŒ–ï¼ˆå¦‚æœé”®æœ‰é‡å¤æ¨¡å¼ï¼‰
private static final Map<String, String> KEY_POOL = new ConcurrentHashMap<>();  // çº¿ç¨‹å®‰å…¨çš„é”®æ± 

// å¯¹é‡å¤çš„é”®è¿›è¡Œæ± åŒ–ï¼Œå‡å°‘å†…å­˜å ç”¨
public static String internKey(String key) {
    // å¦‚æœé”®å·²å­˜åœ¨äºæ± ä¸­ï¼Œè¿”å›æ± ä¸­çš„å®ä¾‹ï¼›å¦åˆ™æ·»åŠ æ–°é”®
    return KEY_POOL.computeIfAbsent(key, k -> k);
}
```

**ä»£ç è§£é‡Š**: å½“ç³»ç»Ÿä¸­æœ‰å¤§é‡ç›¸ä¼¼çš„é”®ï¼ˆå¦‚"user:1", "user:2"ç­‰ï¼‰æ—¶ï¼Œå­—ç¬¦ä¸²æ± åŒ–å¯ä»¥æ˜¾è‘—å‡å°‘å†…å­˜å ç”¨ã€‚`computeIfAbsent`æ–¹æ³•ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼ŒåŒæ—¶é¿å…é‡å¤çš„å­—ç¬¦ä¸²å¯¹è±¡ã€‚

### 2. åºåˆ—åŒ–è€ƒè™‘

ä¸ºäº†æŒä¹…åŒ–åˆ°SSTableï¼ŒKeyValueéœ€è¦æ”¯æŒåºåˆ—åŒ–ï¼š

```java
// åºåˆ—åŒ–æ ¼å¼ï¼škey|value|timestamp|deleted
public String serialize() {
    return String.format("%s|%s|%d|%b", 
                        key,                                    // é”®
                        value != null ? value : "",             // å€¼ï¼ˆnullæ—¶ç”¨ç©ºå­—ç¬¦ä¸²è¡¨ç¤ºï¼‰
                        timestamp,                              // æ—¶é—´æˆ³
                        deleted);                               // åˆ é™¤æ ‡è®°
}

// ååºåˆ—åŒ–ï¼šä»å­—ç¬¦ä¸²æ¢å¤KeyValueå¯¹è±¡
public static KeyValue deserialize(String line) {
    String[] parts = line.split("\\|");                       // æŒ‰åˆ†éš”ç¬¦åˆ†å‰²
    String key = parts[0];                                     // è§£æé”®
    String value = parts[1].isEmpty() ? null : parts[1];       // è§£æå€¼ï¼ˆç©ºå­—ç¬¦ä¸²è½¬ä¸ºnullï¼‰
    long timestamp = Long.parseLong(parts[2]);                 // è§£ææ—¶é—´æˆ³
    boolean deleted = Boolean.parseBoolean(parts[3]);          // è§£æåˆ é™¤æ ‡è®°
    
    // ä½¿ç”¨ç§æœ‰æ„é€ å‡½æ•°åˆ›å»ºKeyValueå¯¹è±¡
    return new KeyValue(key, value, timestamp, deleted);
}
```

**ä»£ç è§£é‡Š**: åºåˆ—åŒ–æ–¹æ³•å°†KeyValueå¯¹è±¡è½¬æ¢ä¸ºå¯ä»¥å­˜å‚¨åˆ°ç£ç›˜çš„å­—ç¬¦ä¸²æ ¼å¼ã€‚æˆ‘ä»¬ä½¿ç”¨ç®¡é“ç¬¦(|)ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¹¶ç‰¹åˆ«å¤„ç†nullå€¼ã€‚ååºåˆ—åŒ–è¿‡ç¨‹åˆ™æ˜¯é€†å‘æ“ä½œï¼Œä»å­—ç¬¦ä¸²é‡å»ºKeyValueå¯¹è±¡ã€‚è¿™ç§ç®€å•çš„æ–‡æœ¬æ ¼å¼ä¾¿äºè°ƒè¯•å’Œäººå·¥æ£€æŸ¥ã€‚

### 3. æ¯”è¾ƒå’Œæ’åº

ä¸ºäº†æ”¯æŒæœ‰åºå­˜å‚¨ï¼ŒKeyValueå®ç°äº†æ¯”è¾ƒé€»è¾‘ï¼š

```java
// å®ç°Comparableæ¥å£ï¼Œæ”¯æŒè‡ªç„¶æ’åº
public int compareTo(KeyValue other) {
    // é¦–å…ˆæŒ‰é”®è¿›è¡Œå­—å…¸åºæ¯”è¾ƒ
    int keyCompare = this.key.compareTo(other.key);
    if (keyCompare != 0) {
        return keyCompare;  // é”®ä¸åŒæ—¶ï¼Œç›´æ¥è¿”å›é”®çš„æ¯”è¾ƒç»“æœ
    }
    // é”®ç›¸åŒæ—¶ï¼ŒæŒ‰æ—¶é—´æˆ³å€’åºæ’åºï¼ˆè¾ƒæ–°çš„æ’åœ¨å‰é¢ï¼‰
    return Long.compare(other.timestamp, this.timestamp);
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªæ¯”è¾ƒæ–¹æ³•é¦–å…ˆæŒ‰é”®è¿›è¡Œæ’åºï¼Œç¡®ä¿ç›¸åŒé”®çš„è®°å½•èšé›†åœ¨ä¸€èµ·ã€‚å½“é”®ç›¸åŒæ—¶ï¼ŒæŒ‰æ—¶é—´æˆ³å€’åºæ’åˆ—ï¼Œè¿™æ ·åœ¨æŸ¥æ‰¾æ—¶å¯ä»¥å¿«é€Ÿæ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚è¿™ç§æ’åºç­–ç•¥æ˜¯LSM Treeé«˜æ•ˆæŸ¥è¯¢çš„åŸºç¡€ã€‚

## æ€§èƒ½å½±å“

### 1. å¯¹è±¡åˆ›å»ºå¼€é”€

æ¯æ¬¡å†™å…¥éƒ½ä¼šåˆ›å»ºæ–°çš„KeyValueå¯¹è±¡ï¼š

```java
// æµ‹è¯•å¯¹è±¡åˆ›å»ºæ€§èƒ½
public void benchmarkKeyValueCreation() {
    long start = System.nanoTime();  // è®°å½•å¼€å§‹æ—¶é—´ï¼ˆçº³ç§’ç²¾åº¦ï¼‰
    
    // å¾ªç¯åˆ›å»º10ä¸‡ä¸ªKeyValueå¯¹è±¡
    for (int i = 0; i < 100_000; i++) {
        KeyValue kv = new KeyValue("key" + i, "value" + i);  // åˆ›å»ºæ–°å¯¹è±¡
    }
    
    long duration = System.nanoTime() - start;  // è®¡ç®—è€—æ—¶
    System.out.printf("åˆ›å»º10ä¸‡ä¸ªKeyValue: %.2f ms%n", duration / 1_000_000.0);
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªåŸºå‡†æµ‹è¯•è¡¡é‡KeyValueå¯¹è±¡çš„åˆ›å»ºå¼€é”€ã€‚ç”±äºLSM Treeéœ€è¦é¢‘ç¹åˆ›å»ºKeyValueå¯¹è±¡ï¼Œäº†è§£è¿™ä¸ªå¼€é”€å¯¹æ€§èƒ½ä¼˜åŒ–å¾ˆé‡è¦ã€‚ä½¿ç”¨çº³ç§’è®¡æ—¶å™¨å¯ä»¥å¾—åˆ°æ›´ç²¾ç¡®çš„æµ‹é‡ç»“æœã€‚

**å…¸å‹ç»“æœ**: åˆ›å»º10ä¸‡ä¸ªKeyValueçº¦éœ€è¦10-20msï¼Œå¯¹æ•´ä½“æ€§èƒ½å½±å“å¾ˆå°ã€‚

### 2. å†…å­˜å ç”¨

```java
// ä¼°ç®—KeyValueå†…å­˜å ç”¨
public static long estimateMemoryUsage(String key, String value) {
    // å¯¹è±¡å¤´ï¼š12å­—èŠ‚ï¼ˆå¼€å¯å‹ç¼©OOPçš„64ä½JVMï¼‰
    long objectHeader = 12;
    // 4ä¸ªå­—æ®µå¼•ç”¨ï¼šæ¯ä¸ªå¼•ç”¨4å­—èŠ‚ï¼ˆå‹ç¼©OOPï¼‰
    long fieldReferences = 4 * 4;  // key, value, timestamp, deletedçš„å¼•ç”¨
    // long timestampï¼š8å­—èŠ‚
    long timestampSize = 8;
    // boolean deletedï¼šå®é™…å ç”¨4å­—èŠ‚ï¼ˆJVMå¯¹é½ï¼‰
    long deletedSize = 4;
    
    long objectOverhead = objectHeader + fieldReferences + timestampSize + deletedSize;
    
    // å­—ç¬¦ä¸²å¯¹è±¡çš„å¤§å°ï¼ˆåŒ…æ‹¬å­—ç¬¦ä¸²å¯¹è±¡å¤´å’Œå­—ç¬¦æ•°ç»„ï¼‰
    long stringSize = estimateStringSize(key) + estimateStringSize(value);
    
    return objectOverhead + stringSize;  // è¿”å›æ€»å†…å­˜å ç”¨
}

// ä¼°ç®—å­—ç¬¦ä¸²çš„å†…å­˜å ç”¨
private static long estimateStringSize(String str) {
    if (str == null) return 0;
    // Stringå¯¹è±¡å¤´ï¼ˆ12å­—èŠ‚ï¼‰+ hashå­—æ®µï¼ˆ4å­—èŠ‚ï¼‰+ charæ•°ç»„å¼•ç”¨ï¼ˆ4å­—èŠ‚ï¼‰
    long stringObjectSize = 12 + 4 + 4;
    // charæ•°ç»„ï¼šæ•°ç»„å¤´ï¼ˆ12å­—èŠ‚ï¼‰+ å­—ç¬¦æ•°æ®ï¼ˆæ¯å­—ç¬¦2å­—èŠ‚ï¼‰
    long charArraySize = 12 + str.length() * 2;
    return stringObjectSize + charArraySize;
}
```

**ä»£ç è§£é‡Š**: è¿™ä¸ªæ–¹æ³•ä¼°ç®—KeyValueå¯¹è±¡çš„å†…å­˜å ç”¨ã€‚ç†è§£å†…å­˜ä½¿ç”¨æ¨¡å¼æœ‰åŠ©äºä¼˜åŒ–ç³»ç»Ÿæ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯åœ¨å†…å­˜å—é™çš„ç¯å¢ƒä¸­ã€‚è®¡ç®—åŒ…æ‹¬äº†JVMå¯¹è±¡å¤´ã€å­—æ®µå¼•ç”¨ã€ä»¥åŠå­—ç¬¦ä¸²å¯¹è±¡çš„å®é™…å†…å­˜å ç”¨ã€‚

## å¸¸è§é—®é¢˜

### 1. ä¸ºä»€ä¹ˆä¸ç›´æ¥ç‰©ç†åˆ é™¤ï¼Ÿ

**é—®é¢˜**: ä¸ºä»€ä¹ˆdeleteæ“ä½œè¦æ’å…¥å¢“ç¢‘è€Œä¸æ˜¯ç›´æ¥åˆ é™¤ï¼Ÿ

**ç­”æ¡ˆ**: 
- SSTableæ–‡ä»¶æ˜¯ä¸å¯å˜çš„ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹
- ç«‹å³åˆ é™¤éœ€è¦é‡å†™æ–‡ä»¶ï¼Œæ€§èƒ½å¼€é”€å·¨å¤§
- å¢“ç¢‘ç¡®ä¿åˆ é™¤æ“ä½œçš„æŒä¹…æ€§å’Œä¸€è‡´æ€§

### 2. å¢“ç¢‘ä½•æ—¶è¢«æ¸…ç†ï¼Ÿ

**æ¸…ç†æ—¶æœº**:
1. **å‹ç¼©è¿‡ç¨‹**: åˆå¹¶SSTableæ—¶æ¸…ç†è¿‡æœŸå¢“ç¢‘
2. **TTLè¿‡æœŸ**: å¢“ç¢‘è¶…è¿‡ç”Ÿå­˜æ—¶é—´åæ¸…ç†
3. **æ‰‹åŠ¨å‹ç¼©**: ç”¨æˆ·ä¸»åŠ¨è§¦å‘çš„æ¸…ç†æ“ä½œ

### 3. æ—¶é—´æˆ³å†²çªæ€ä¹ˆåŠï¼Ÿ

**å†²çªåœºæ™¯**: ä¸¤ä¸ªå†™å…¥æ“ä½œå‘ç”Ÿåœ¨åŒä¸€æ¯«ç§’å†…

**è§£å†³æ–¹æ¡ˆ**:
```java
// åœ¨å®é™…å®ç°ä¸­å¯ä»¥è€ƒè™‘ä½¿ç”¨çº³ç§’æˆ–åºåˆ—å·
private static final AtomicLong SEQUENCE = new AtomicLong(0);  // åŸå­åºåˆ—å·ç”Ÿæˆå™¨

public KeyValue(String key, String value) {
    this.key = key;
    this.value = value;
    // æ¯«ç§’æ—¶é—´æˆ³ * 1000 + åºåˆ—å·ï¼Œç¡®ä¿å”¯ä¸€æ€§
    this.timestamp = System.currentTimeMillis() * 1000 + SEQUENCE.incrementAndGet() % 1000;
    this.deleted = false;
}
```

**ä»£ç è§£é‡Š**: é€šè¿‡å°†æ¯«ç§’æ—¶é—´æˆ³æ‰©å±•åˆ°å¾®ç§’çº§åˆ«ï¼Œå¹¶æ·»åŠ åŸå­åºåˆ—å·ï¼Œæˆ‘ä»¬å¯ä»¥ç¡®ä¿å³ä½¿åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹æ—¶é—´æˆ³ä¹Ÿæ˜¯å”¯ä¸€çš„ã€‚è¿™ç§æ–¹æ³•ç»“åˆäº†æ—¶é—´çš„è‡ªç„¶æ’åºç‰¹æ€§å’Œåºåˆ—å·çš„å”¯ä¸€æ€§ã€‚

## å°ç»“

KeyValueæ˜¯LSM Treeçš„åŸºç¡€æ•°æ®ç»“æ„ï¼Œå®ƒé€šè¿‡ä»¥ä¸‹è®¾è®¡æ»¡è¶³äº†LSM Treeçš„éœ€æ±‚ï¼š

1. **æ—¶é—´æˆ³**: æä¾›ç‰ˆæœ¬æ§åˆ¶å’Œå†²çªè§£å†³
2. **åˆ é™¤æ ‡è®°**: æ”¯æŒLSM Treeçš„åˆ é™¤è¯­ä¹‰
3. **ä¸å¯å˜æ€§**: ç¡®ä¿çº¿ç¨‹å®‰å…¨å’Œæ•°æ®ä¸€è‡´æ€§
4. **è½»é‡çº§**: æœ€å°åŒ–å†…å­˜å’ŒCPUå¼€é”€


---

## æ€è€ƒé¢˜

1. å¦‚æœç³»ç»Ÿæ—¶é’Ÿå›æ‹¨ï¼Œæ—¶é—´æˆ³ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿå¦‚ä½•è§£å†³ï¼Ÿ
2. å¢“ç¢‘æ ‡è®°ä¼šä¸€ç›´å­˜åœ¨å—ï¼Ÿä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥å®‰å…¨æ¸…ç†ï¼Ÿ
3. å¦‚ä½•ä¼˜åŒ–KeyValueçš„å†…å­˜ä½¿ç”¨ï¼Ÿ

