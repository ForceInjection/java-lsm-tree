ğŸ”¥ æ¨èä¸€ä¸ªé«˜è´¨é‡çš„Java LSM Treeå¼€æºé¡¹ç›®ï¼
[https://github.com/brianxiadong/java-lsm-tree](https://github.com/brianxiadong/java-lsm-tree)
**java-lsm-tree** æ˜¯ä¸€ä¸ªä»é›¶å®ç°çš„Log-Structured Merge Treeï¼Œä¸“ä¸ºé«˜å¹¶å‘å†™å…¥åœºæ™¯è®¾è®¡ã€‚
æ ¸å¿ƒäº®ç‚¹ï¼š
âš¡ æè‡´æ€§èƒ½ï¼šå†™å…¥é€Ÿåº¦è¶…è¿‡40ä¸‡ops/ç§’ï¼Œå®Œçˆ†ä¼ ç»ŸB+æ ‘
ğŸ—ï¸ å®Œæ•´æ¶æ„ï¼šMemTableè·³è¡¨ + SSTable + WAL + å¸ƒéš†è¿‡æ»¤å™¨ + å¤šçº§å‹ç¼©
ğŸ“š æ·±åº¦æ•™ç¨‹ï¼š12ç« è¯¦ç»†æ•™ç¨‹ï¼Œä»åŸºç¡€æ¦‚å¿µåˆ°ç”Ÿäº§ä¼˜åŒ–ï¼Œæ¯è¡Œä»£ç éƒ½æœ‰æ³¨é‡Š
ğŸ”’ å¹¶å‘å®‰å…¨ï¼šè¯»å†™é”æœºåˆ¶ï¼Œæ”¯æŒé«˜å¹¶å‘åœºæ™¯
ğŸ’¾ æ•°æ®å¯é ï¼šWALå†™å‰æ—¥å¿—ç¡®ä¿å´©æºƒæ¢å¤ï¼Œé›¶æ•°æ®ä¸¢å¤±
é€‚åˆè°ï¼Ÿ
- æƒ³æ·±å…¥ç†è§£LSM TreeåŸç†çš„å¼€å‘è€…
- éœ€è¦é«˜å†™å…¥æ€§èƒ½å­˜å‚¨å¼•æ“çš„é¡¹ç›®
- å‡†å¤‡æ•°æ®åº“/å­˜å‚¨ç³»ç»Ÿé¢è¯•çš„åŒå­¦
- å¯¹åˆ†å¸ƒå¼å­˜å‚¨æ„Ÿå…´è¶£çš„å·¥ç¨‹å¸ˆ
â­ ç»™ä¸ªStaræ”¯æŒå¼€æºï¼

# ç¬¬5ç« ï¼šå¸ƒéš†è¿‡æ»¤å™¨

## ä»€ä¹ˆæ˜¯å¸ƒéš†è¿‡æ»¤å™¨ï¼Ÿ

**å¸ƒéš†è¿‡æ»¤å™¨ (Bloom Filter)** æ˜¯ä¸€ç§æ¦‚ç‡å‹æ•°æ®ç»“æ„ï¼Œç”¨äºå¿«é€Ÿåˆ¤æ–­ä¸€ä¸ªå…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨äºé›†åˆä¸­ã€‚å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- **æ— å‡é˜´æ€§**: å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è¯´å…ƒç´ ä¸å­˜åœ¨ï¼Œé‚£ä¹ˆå…ƒç´ ä¸€å®šä¸å­˜åœ¨
- **æœ‰å‡é˜³æ€§**: å¦‚æœå¸ƒéš†è¿‡æ»¤å™¨è¯´å…ƒç´ å­˜åœ¨ï¼Œå…ƒç´ å¯èƒ½ä¸å­˜åœ¨
- **ç©ºé—´é«˜æ•ˆ**: ç›¸æ¯”å“ˆå¸Œè¡¨ï¼Œå†…å­˜å ç”¨æå°
- **æ—¶é—´é«˜æ•ˆ**: æŸ¥è¯¢å’Œæ’å…¥éƒ½æ˜¯O(k)ï¼Œkæ˜¯å“ˆå¸Œå‡½æ•°æ•°é‡

## å¸ƒéš†è¿‡æ»¤å™¨åœ¨LSM Treeä¸­çš„ä½œç”¨

åœ¨LSM Treeä¸­ï¼Œå¸ƒéš†è¿‡æ»¤å™¨è¢«å¹¿æ³›åº”ç”¨äºSSTableæ–‡ä»¶ä¸­ï¼š

```
æŸ¥è¯¢æµç¨‹:
1. æ£€æŸ¥MemTable (å¯èƒ½å­˜åœ¨)
2. æ£€æŸ¥Immutable MemTable (å¯èƒ½å­˜åœ¨)  
3. å¯¹æ¯ä¸ªSSTable:
   a. æ£€æŸ¥å¸ƒéš†è¿‡æ»¤å™¨ (å¯èƒ½å­˜åœ¨ï¼Ÿ)
   b. å¦‚æœå¯èƒ½å­˜åœ¨ï¼Œè¯»å–æ–‡ä»¶æŸ¥æ‰¾
   c. å¦‚æœä¸å­˜åœ¨ï¼Œç›´æ¥è·³è¿‡ (é¿å…ç£ç›˜I/O)
```
> Immutable MemTableæŒ‡çš„æ˜¯æ•°æ®å·²æ»¡ï¼Œå‡†å¤‡å†™åˆ°ç£ç›˜ä¸­çš„MemTable

**æ€§èƒ½æå‡**: å¸ƒéš†è¿‡æ»¤å™¨å¯ä»¥å‡å°‘90%ä»¥ä¸Šçš„æ— æ•ˆç£ç›˜I/Oæ“ä½œï¼

## æ ¸å¿ƒåŸç†

### å·¥ä½œæœºåˆ¶å›¾è§£

**æ­¥éª¤1: åˆå§‹çŠ¶æ€**
| ä½ç½® | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10| 11| 12| 13| 14| 15|
|------|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| ä½å€¼ | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 | 0 |

**æ­¥éª¤2: æ·»åŠ  "apple"**
- hash1("apple") = 3, hash2("apple") = 7, hash3("apple") = 12

| ä½ç½® | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10| 11| 12| 13| 14| 15|
|------|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| ä½å€¼ | 0 | 0 | 0 |**1**| 0 | 0 | 0 |**1**| 0 | 0 | 0 | 0 |**1**| 0 | 0 | 0 |

**æ­¥éª¤3: æ·»åŠ  "banana"**  
- hash1("banana") = 1, hash2("banana") = 9, hash3("banana") = 15

| ä½ç½® | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10| 11| 12| 13| 14| 15|
|------|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| ä½å€¼ | 0 |**1**| 0 |**1**| 0 | 0 | 0 |**1**| 0 |**1**| 0 | 0 |**1**| 0 | 0 |**1**|

**æ­¥éª¤4: æŸ¥è¯¢æµ‹è¯•**

| å…ƒç´  | hashä½ç½® | ä½å€¼æ£€æŸ¥ | ç»“æœ | è¯´æ˜ |
|------|----------|----------|------|------|
| "apple" | 3,7,12 | 1,1,1 | âœ… å¯èƒ½å­˜åœ¨ | ç¡®å®å­˜åœ¨ |
| "cherry" | 2,6,10 | 0,0,0 | âŒ ç¡®å®šä¸å­˜åœ¨ | ä½ç½®2ä¸º0 |
| "grape" | 1,7,9 | 1,1,1 | âš ï¸ å¯èƒ½å­˜åœ¨ | å‡é˜³æ€§! |

**æ ¸å¿ƒæ´å¯Ÿ**:
- **æ’å…¥**: å¤šä¸ªå“ˆå¸Œå‡½æ•°å°†å…ƒç´ æ˜ å°„åˆ°ä¸åŒä½ç½®ï¼Œå…¨éƒ¨è®¾ä¸º1
- **æŸ¥è¯¢**: æ£€æŸ¥æ‰€æœ‰å¯¹åº”ä½ç½®ï¼Œä»»ä¸€ä¸º0åˆ™ç¡®å®šä¸å­˜åœ¨
- **å‡é˜³æ€§**: ä¸åŒå…ƒç´ å¯èƒ½hashåˆ°ç›¸åŒä½ç½®ï¼Œå¯¼è‡´è¯¯åˆ¤
- **æ— å‡é˜´æ€§**: å¦‚æœå…ƒç´ çœŸå®å­˜åœ¨ï¼Œå¯¹åº”ä½ç½®å¿…ç„¶ä¸º1


## å¸ƒéš†è¿‡æ»¤å™¨å®ç°

### æ ¸å¿ƒå®ç°

```java
package com.brianxiadong.lsmtree;

import java.util.BitSet;

/**
 * å¸ƒéš†è¿‡æ»¤å™¨å®ç°
 * ç”¨äºå¿«é€Ÿåˆ¤æ–­é”®æ˜¯å¦å¯èƒ½å­˜åœ¨äºSSTableä¸­
 */
public class BloomFilter {
    private final BitSet bitSet;               // ä½æ•°ç»„ï¼Œå­˜å‚¨å¸ƒéš†è¿‡æ»¤å™¨çš„ä½
    private final int size;                    // ä½æ•°ç»„çš„å¤§å°
    private final int hashFunctions;           // å“ˆå¸Œå‡½æ•°çš„æ•°é‡

    // æ„é€ å‡½æ•°ï¼šæ ¹æ®é¢„æœŸå…ƒç´ æ•°å’Œå‡é˜³æ€§æ¦‚ç‡åˆå§‹åŒ–
    public BloomFilter(int expectedElements, double falsePositiveProbability) {
        // è®¡ç®—æœ€ä¼˜ä½æ•°ç»„å¤§å°ï¼šm = -n * ln(p) / (ln(2))^2
        this.size = (int) (-expectedElements * Math.log(falsePositiveProbability)
                / (Math.log(2) * Math.log(2)));
        // è®¡ç®—æœ€ä¼˜å“ˆå¸Œå‡½æ•°ä¸ªæ•°ï¼šk = (m/n) * ln(2)
        this.hashFunctions = (int) (size * Math.log(2) / expectedElements);
        this.bitSet = new BitSet(size);        // åˆ›å»ºä½æ•°ç»„
    }

    /**
     * å‘å¸ƒéš†è¿‡æ»¤å™¨æ·»åŠ å…ƒç´ 
     */
    public void add(String key) {
        for (int i = 0; i < hashFunctions; i++) {      // ä½¿ç”¨kä¸ªå“ˆå¸Œå‡½æ•°
            int hash = hash(key, i);                   // è®¡ç®—ç¬¬iä¸ªå“ˆå¸Œå€¼
            bitSet.set(Math.abs(hash % size));         // è®¾ç½®å¯¹åº”ä½ä¸º1
        }
    }

    /**
     * æ£€æŸ¥å…ƒç´ æ˜¯å¦å¯èƒ½å­˜åœ¨
     * è¿”å›falseè¡¨ç¤ºç»å¯¹ä¸å­˜åœ¨
     * è¿”å›trueè¡¨ç¤ºå¯èƒ½å­˜åœ¨
     */
    public boolean mightContain(String key) {
        for (int i = 0; i < hashFunctions; i++) {      // æ£€æŸ¥kä¸ªå“ˆå¸Œä½ç½®
            int hash = hash(key, i);                   // è®¡ç®—ç¬¬iä¸ªå“ˆå¸Œå€¼
            if (!bitSet.get(Math.abs(hash % size))) {  // å¦‚æœä»»ä¸€ä½ä¸º0
                return false;                          // ç¡®å®šä¸å­˜åœ¨
            }
        }
        return true;                                   // æ‰€æœ‰ä½éƒ½ä¸º1ï¼Œå¯èƒ½å­˜åœ¨
    }

    /**
     * å¤šé‡å“ˆå¸Œå‡½æ•°å®ç°
     * ä½¿ç”¨Double HashingæŠ€æœ¯é¿å…å®ç°å¤šä¸ªç‹¬ç«‹çš„å“ˆå¸Œå‡½æ•°
     */
    private int hash(String key, int i) {
        int hash1 = key.hashCode();                    // ç¬¬ä¸€ä¸ªå“ˆå¸Œå€¼
        int hash2 = hash1 >>> 16;                      // ç¬¬äºŒä¸ªå“ˆå¸Œå€¼ï¼ˆé«˜16ä½ï¼‰
        return hash1 + i * hash2;                      // ç»„åˆç”Ÿæˆç¬¬iä¸ªå“ˆå¸Œå€¼
    }

    /**
     * è·å–ä½æ•°ç»„åºåˆ—åŒ–æ•°æ®ï¼ˆç”¨äºæŒä¹…åŒ–ï¼‰
     */
    public byte[] toByteArray() {
        return bitSet.toByteArray();                   // å°†BitSetè½¬æ¢ä¸ºå­—èŠ‚æ•°ç»„
    }

    /**
     * ä»å­—èŠ‚æ•°ç»„æ¢å¤å¸ƒéš†è¿‡æ»¤å™¨
     */
    public static BloomFilter fromByteArray(byte[] data, int size, int hashFunctions) {
        BloomFilter filter = new BloomFilter(1000, 0.01); // ä¸´æ—¶åˆ›å»ºå‚æ•°
        filter.bitSet.clear();                         // æ¸…ç©ºå½“å‰ä½æ•°ç»„
        BitSet restored = BitSet.valueOf(data);        // ä»å­—èŠ‚æ•°ç»„æ¢å¤BitSet
        filter.bitSet.or(restored);                    // åˆå¹¶åˆ°å½“å‰ä½æ•°ç»„
        return filter;
    }
}
```

**ä»£ç è§£æ**ï¼šè¿™ä¸ªå¸ƒéš†è¿‡æ»¤å™¨å®ç°é‡‡ç”¨äº†ç»å…¸çš„è®¾è®¡æ¨¡å¼ã€‚æ„é€ å‡½æ•°æ ¹æ®æ•°å­¦å…¬å¼è®¡ç®—æœ€ä¼˜çš„ä½æ•°ç»„å¤§å°å’Œå“ˆå¸Œå‡½æ•°æ•°é‡ï¼Œç¡®ä¿åœ¨ç»™å®šçš„å‡é˜³æ€§ç‡ä¸‹è¾¾åˆ°æœ€ä½³æ€§èƒ½ã€‚åŒé‡å“ˆå¸ŒæŠ€æœ¯é¿å…äº†å®ç°å¤šä¸ªç‹¬ç«‹å“ˆå¸Œå‡½æ•°çš„å¤æ‚æ€§ï¼Œé€šè¿‡ç»„åˆä¸¤ä¸ªåŸºç¡€å“ˆå¸Œå€¼ç”Ÿæˆæ‰€éœ€æ•°é‡çš„å“ˆå¸Œå€¼ã€‚`toByteArray`å’Œ`fromByteArray`æ–¹æ³•æ”¯æŒå¸ƒéš†è¿‡æ»¤å™¨çš„æŒä¹…åŒ–ï¼Œè¿™åœ¨SSTableæ–‡ä»¶ä¸­å­˜å‚¨å¸ƒéš†è¿‡æ»¤å™¨æ—¶éå¸¸æœ‰ç”¨ã€‚


## å°ç»“

å¸ƒéš†è¿‡æ»¤å™¨æ˜¯LSM Treeæ€§èƒ½ä¼˜åŒ–çš„å…³é”®ç»„ä»¶ï¼š

1. **ç©ºé—´æ•ˆç‡**: æå°çš„å†…å­˜å ç”¨
2. **æ—¶é—´æ•ˆç‡**: O(k)çš„æŸ¥è¯¢æ—¶é—´
3. **å‡é˜³æ€§æƒè¡¡**: æ¥å—å‡é˜³æ€§æ¢å–æ€§èƒ½æå‡
4. **å¹¿æ³›åº”ç”¨**: ç¼“å­˜ã€æ•°æ®åº“ã€ç½‘ç»œç­‰åœºæ™¯

## ä¸‹ä¸€æ­¥å­¦ä¹ 

ç°åœ¨ä½ å·²ç»ç†è§£äº†å¸ƒéš†è¿‡æ»¤å™¨çš„å·¥ä½œåŸç†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†å­¦ä¹ WALå†™å‰æ—¥å¿—ï¼š

---

## æ€è€ƒé¢˜

1. ä¸ºä»€ä¹ˆå¸ƒéš†è¿‡æ»¤å™¨ä¸èƒ½æ”¯æŒåˆ é™¤æ“ä½œï¼Ÿ
2. å¦‚ä½•é€‰æ‹©æœ€ä¼˜çš„å‡é˜³æ€§ç‡ï¼Ÿ
3. åœ¨ä»€ä¹ˆæƒ…å†µä¸‹å¸ƒéš†è¿‡æ»¤å™¨çš„æ€§èƒ½æå‡ä¸æ˜æ˜¾ï¼Ÿ
