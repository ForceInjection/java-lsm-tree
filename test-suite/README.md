# Java LSM Tree 测试套件指南

本目录包含了 Java LSM Tree 项目的完整测试套件，提供功能测试、性能测试、内存分析和压力测试，并具备智能会话管理功能。

## 1. 目录结构

```bash
test-suite/
├── test-suite.sh        # 测试套件主入口脚本
├── README.md           # 本文件
├── lib/                # 模块化库文件目录
│   ├── common.sh       # 公共函数库
│   ├── session.sh      # 会话管理模块
│   ├── tests.sh        # 测试执行模块
│   └── reports.sh      # 报告生成模块
└── results/            # 测试结果目录（自动创建）
    ├── sessions/       # 测试会话目录
    └── archive/        # 归档会话目录
```

## 2. 快速开始

### 2.1 基本测试命令

```bash
# 运行所有测试（推荐）
./test-suite.sh all

# 运行特定测试类型
./test-suite.sh functional    # 功能测试
./test-suite.sh performance   # 性能测试
./test-suite.sh memory        # 内存分析
./test-suite.sh stress        # 压力测试
```

### 2.2 会话管理命令

```bash
# 查看所有测试会话
./test-suite.sh list

# 显示指定会话详情
./test-suite.sh show <会话ID>

# 删除指定会话
./test-suite.sh delete <会话ID>

# 重新生成会话报告
./test-suite.sh report <会话ID>
```

### 2.3 清理和归档命令

```bash
# 清理当前测试环境
./test-suite.sh clean

# 清理所有测试数据
./test-suite.sh clean-all

# 归档旧会话（默认30天前）
./test-suite.sh archive [天数]
```

## 3. 功能特性

### 3.1 测试模块

#### 3.1.1 功能测试 (functional)

- **基本功能验证**: 验证 LSM Tree 的基本 CRUD 操作
- **数据一致性检查**: 确保数据读写的正确性
- **功能示例测试**: 运行完整的功能演示示例

#### 3.1.2 性能测试 (performance)

- **顺序写入测试**: 测试大量顺序数据写入的性能
- **随机写入测试**: 测试随机数据写入的性能
- **读取性能测试**: 测试数据查询的性能
- **混合工作负载**: 模拟真实场景的读写混合操作
- **延迟分析**: 分析写入和读取操作的延迟分布

#### 3.1.3 内存分析 (memory)

- **GC 行为分析**: 监控垃圾回收的频率和耗时
- **内存使用模式**: 分析内存分配和释放模式
- **堆内存统计**: 提供详细的堆内存使用信息

#### 3.1.4 压力测试 (stress)

- **多线程并发测试**: 模拟高并发场景
- **大数据量测试**: 测试系统在大数据量下的稳定性
- **长时间运行测试**: 验证系统的长期稳定性

### 3.2 智能会话管理

#### 3.2.1 会话复用机制

- **自动检测**: 智能检测未完成的测试会话
- **用户选择**: 提供复用现有会话或创建新会话的选项
- **状态跟踪**: 实时跟踪测试进度和会话状态

#### 3.2.2 会话历史管理

- **历史记录**: 保存所有测试会话的完整历史
- **详细查看**: 支持查看任意历史会话的详细信息
- **报告重生成**: 可重新生成任意会话的测试报告

#### 3.2.3 数据归档清理

- **自动归档**: 支持按时间自动归档旧会话
- **选择性清理**: 提供精确的数据清理选项
- **存储优化**: 有效管理磁盘空间使用

### 3.3 模块化设计

#### 3.3.1 核心模块

- **common.sh**: 公共函数库，提供日志、工具函数
- **session.sh**: 会话管理模块，处理会话生命周期
- **tests.sh**: 测试执行模块，实现各类测试逻辑
- **reports.sh**: 报告生成模块，生成 HTML 测试报告

#### 3.3.2 设计优势

- **高内聚低耦合**: 模块间职责清晰，易于维护
- **可扩展性**: 便于添加新的测试类型和功能
- **代码复用**: 公共功能统一管理，避免重复

## 4. 测试结果

### 4.1 结果存储结构

测试完成后，结果将保存在 `results/` 目录中：

```bash
results/
├── sessions/                  # 测试会话目录
│   ├── 20241026_174348/      # 会话ID（时间戳格式）
│   │   ├── functional_test.log
│   │   ├── performance_test.log
│   │   ├── memory_analysis.log
│   │   ├── stress_test.log
│   │   ├── test_report.html
│   │   └── session_info.txt
│   └── ...
└── archive/                   # 归档的历史会话
    ├── 20241025_143022/
    └── ...
```

### 4.2 测试报告

#### HTML 报告特性

- **测试执行摘要**: 整体测试状态和统计信息
- **模块化结果**: 各测试模块的详细结果
- **性能指标图表**: 可视化的性能数据展示
- **内存使用分析**: 详细的内存使用情况
- **错误诊断**: 完整的错误和警告信息

#### 报告访问方式

```bash
# 查看最新会话报告
open results/sessions/<最新会话ID>/test_report.html

# 重新生成指定会话报告
./test-suite.sh report <会话ID>
```

### 4.3 会话管理

#### 会话信息

每个测试会话包含：

- **会话 ID**: 基于时间戳的唯一标识
- **测试类型**: 执行的测试模块类型
- **执行状态**: 完成、进行中或失败状态
- **时间信息**: 开始时间、结束时间和持续时间
- **结果摘要**: 测试通过率和关键指标

### 4.4 结果解读

#### 性能指标

- **吞吐量 (Throughput)**: 每秒处理的操作数
- **延迟 (Latency)**: 单个操作的响应时间
  - P50: 50% 的操作在此时间内完成
  - P95: 95% 的操作在此时间内完成
  - P99: 99% 的操作在此时间内完成

#### 内存指标

- **堆内存使用**: JVM 堆内存的使用情况
- **GC 统计**: 垃圾回收的频率和耗时
- **内存泄漏检测**: 是否存在内存泄漏风险

## 5. 配置说明

### 5.1 测试参数配置

可以通过修改脚本中的配置变量来调整测试参数：

```bash
# 性能测试配置
PERFORMANCE_ITERATIONS=1000000
PERFORMANCE_THREADS=4

# 内存测试配置
MEMORY_HEAP_SIZE="2g"
MEMORY_SAMPLE_INTERVAL=100

# 压力测试配置
STRESS_DURATION=300
STRESS_CONCURRENT_USERS=50
```

### 5.2 环境要求

- **Java**: 11 或更高版本
- **Maven**: 3.6 或更高版本
- **内存**: 至少 4GB 可用内存
- **磁盘**: 至少 2GB 可用磁盘空间

## 6. 故障排除

### 6.1 常见问题

#### 内存不足错误

- 增加 JVM 堆内存大小
- 检查系统可用内存

#### 测试超时

- 调整测试超时时间
- 检查系统负载

#### 权限错误

- 确保脚本有执行权限：`chmod +x test-suite.sh`
- 检查结果目录的写入权限

### 6.2 日志分析

详细的错误信息可以在以下位置找到：

- **会话日志**: `results/sessions/<会话ID>/*.log`
- **系统日志**: 通过 `./test-suite.sh show <会话ID>` 查看
- **实时日志**: 测试执行过程中的控制台输出

## 7. 最佳实践

### 7.1 测试建议

- **定期执行**: 建议在代码变更后执行完整测试
- **基线建立**: 建立性能基线，便于对比分析
- **环境隔离**: 在专用测试环境中执行性能测试
- **结果归档**: 定期归档历史测试结果

### 7.2 性能优化

- **JVM 调优**: 根据测试结果调整 JVM 参数
- **并发控制**: 合理设置并发线程数
- **资源监控**: 监控系统资源使用情况

---
